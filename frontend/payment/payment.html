<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <title>Thanh to√°n ng√¢n h√†ng (VietQR - MBBank)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #0d1a2b;
            color: #fff;
            padding: 30px;
            font-family: "Roboto", sans-serif;
        }


        .card {
            background: rgba(10, 20, 40, 0.95);
            border: 1px solid #223b57;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(34, 193, 255, 0.15);
        }


        img.qr {
            border: 3px solid #22c1ff;
            border-radius: 16px;
            box-shadow: 0 0 20px rgba(34, 193, 255, 0.3);
            margin: 10px 0;
        }


        code {
            background: #111c2f;
            color: #22c1ff;
            padding: 2px 6px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<div class="container" style="max-width:520px">
    <div class="card p-4">
        <h4 class="text-center mb-3">üí≥ Thanh to√°n chuy·ªÉn kho·∫£n (MBBank)</h4>
        <label>S·ªë ti·ªÅn (VNƒê)</label>
        <input id="amount" class="form-control mb-3" value="10000" type="number" min="1000"/>


        <button id="create" class="btn btn-primary w-100 fw-semibold">
            T·∫°o m√£ & Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n
        </button>


        <div id="paybox" class="mt-4 text-center" style="display:none">
            <div id="qrContainer" class="mb-3"></div>
            <div class="alert alert-info text-dark fw-medium" id="info"></div>


            <p>1Ô∏è‚É£ Qu√©t m√£ QR tr√™n (ho·∫∑c chuy·ªÉn kho·∫£n t·ªõi)</p>
            <p><b id="account" class="fs-5"></b> ‚Äì <span id="bank"></span></p>


            <p>2Ô∏è‚É£ <b>B·∫Øt bu·ªôc</b> ghi n·ªôi dung: <code id="code"></code></p>


            <p class="small text-muted">
                Sau khi chuy·ªÉn kho·∫£n, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ki·ªÉm tra Google Sheet v√† hi·ªÉn th·ªã k·∫øt qu·∫£.
            </p>


            <div id="status" class="mt-4 text-center">
                <span style="font-weight:600;">Tr·∫°ng th√°i:</span><br>
                <b id="statustxt" style="color:orange; font-size:18px;">
                    ‚è≥ ƒêang ch·ªù thanh to√°n...
                </b>
            </div>


        </div>
    </div>
</div>


<script>
    const BACKEND = "http://localhost:8080";


    // üü¢ L·∫•y d·ªØ li·ªáu t·ª´ confirmBooking.html (ƒë√£ l∆∞u trong localStorage)
    const bookingData = JSON.parse(localStorage.getItem("successBookingData") || "{}");
    const amountInput = document.getElementById("amount");


    // Hi·ªÉn th·ªã s·∫µn t·ªïng ti·ªÅn (n·∫øu c√≥)
    if (bookingData && bookingData.grandTotal) {
        amountInput.value = bookingData.grandTotal;
    } else {
        amountInput.value = 10000;
    }


    document.getElementById('create').addEventListener('click', async () => {
        const amount = document.getElementById('amount').value.trim();
        const ticketId = bookingData?.ticketId;


        if (!amount || amount <= 0) {
            alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá!");
            return;
        }


        try {
            // üîπ G·ª≠i y√™u c·∫ßu t·∫°o m√£ thanh to√°n
            const res = await fetch(BACKEND + "/api/v1/payments/create", {
                method: "POST",
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ amount, ticketId })
            });


            if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫°o y√™u c·∫ßu thanh to√°n.");
            const data = await res.json();


            if (data.error) {
                alert("‚ùå L·ªói: " + data.error);
                return;
            }


            // ‚úÖ Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n + QR
            document.getElementById('paybox').style.display = 'block';
            document.getElementById('account').textContent = data.accountNumber || "0345506824";
            document.getElementById('bank').textContent = data.bankName || "MBBank";
            document.getElementById('code').textContent = data.code;
            document.getElementById('info').textContent = data.noteHint || "Vui l√≤ng ghi ƒë√∫ng n·ªôi dung chuy·ªÉn kho·∫£n ƒë·ªÉ h·ªá th·ªëng nh·∫≠n di·ªán.";


            // ‚úÖ T·∫°o m√£ QR VietQR (MBBank)
            const accountNumber = (data.accountNumber || "0345506824").trim();
            const addInfo = encodeURIComponent(data.code || "CineMaster");
            const bankCode = "970422"; // ‚úÖ M√£ acqId ch√≠nh x√°c c·ªßa MBBank
            const qrUrl = `https://img.vietqr.io/image/${bankCode}-${accountNumber}-compact2.png?amount=${amount}&addInfo=${addInfo}&accountName=CineMaster`;
            console.log("‚úÖ QR URL:", qrUrl); // Debug


            document.getElementById('qrContainer').innerHTML =
                `<img src="${qrUrl}" class="qr" width="250" alt="QR Thanh to√°n">`;
            // ‚úÖ B·∫Øt ƒë·∫ßu ki·ªÉm tra tr·∫°ng th√°i giao d·ªãch (poll Google Sheet)
            pollStatus(data.code, BACKEND + (data.pollUrl || `/api/v1/payments/status/${data.code}`), ticketId);


        } catch (err) {
            console.error(err);
            alert("‚ùå L·ªói khi t·∫°o thanh to√°n: " + err.message);
        }
    });




    // ========================= üß© H√†m ki·ªÉm tra tr·∫°ng th√°i thanh to√°n =========================
    async function pollStatus(code, url, ticketId) {
        const statusEl = document.getElementById('statustxt');
        let tries = 0;
        const maxTries = 30; // ‚è± 2.5 ph√∫t (30 x 5s)
        const pollInterval = 5000;


        statusEl.textContent = 'ƒêang ki·ªÉm tra giao d·ªãch...';
        statusEl.style.color = 'orange';


        const interval = setInterval(async () => {
            tries++;


            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("Kh√¥ng th·ªÉ truy c·∫≠p API tr·∫°ng th√°i.");


                let data;
                try {
                    data = await res.json();
                } catch {
                    console.warn("‚ö†Ô∏è API tr·∫£ v·ªÅ d·ªØ li·ªáu tr·ªëng ho·∫∑c l·ªói JSON.");
                    return;
                }


                // üîπ Log debug
                console.log(`üîÅ L·∫ßn ${tries}:`, data);


                if (data.status === 'paid' || data.status === 'success') {
                    clearInterval(interval);
                    statusEl.textContent = '‚úÖ ƒê√£ nh·∫≠n thanh to√°n!';
                    statusEl.style.color = 'limegreen';


                    alert("‚úÖ Thanh to√°n th√†nh c√¥ng! H·ªá th·ªëng ƒë√£ ph√°t hi·ªán giao d·ªãch.");


                    // üü¢ G·ªçi API x√°c nh·∫≠n v√© (verify-payment)
                    if (ticketId) {
                        try {
                            const verifyRes = await fetch(`${BACKEND}/api/v1/tickets/${ticketId}/verify-payment`);
                            if (!verifyRes.ok) throw new Error("Backend kh√¥ng ph·∫£n h·ªìi ƒë√∫ng.");


                            const verifyData = await verifyRes.json();
                            console.log("üé´ K·∫øt qu·∫£ x√°c nh·∫≠n v√©:", verifyData);


                            // Ki·ªÉm tra ph·∫£n h·ªìi t·ª´ backend
                            if (verifyData?.error || verifyData?.code === 500) {
                                alert("‚ö†Ô∏è L·ªói khi x√°c nh·∫≠n v√©: " + (verifyData.message || "Kh√¥ng r√µ nguy√™n nh√¢n."));
                                return;
                            }


                            // ‚úÖ L∆∞u l·∫°i k·∫øt qu·∫£ ƒë·ªÉ successBooking.html hi·ªÉn th·ªã
                            localStorage.setItem("lastPaymentResult", JSON.stringify({
                                status: "success",
                                ticketId: ticketId,
                                message: "Thanh to√°n & x√°c nh·∫≠n v√© th√†nh c√¥ng!",
                                data: verifyData,
                                time: new Date().toISOString()
                            }));


                            // ‚úÖ Chuy·ªÉn h∆∞·ªõng sang trang th√¥ng b√°o th√†nh c√¥ng
                            statusEl.textContent = 'üéüÔ∏è V√© ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n, ƒëang chuy·ªÉn trang...';
                            statusEl.style.color = 'cyan';


                            setTimeout(() => {
                                window.location.href = "../user/successBooking.html";
                            }, 2000);


                            return; // D·ª´ng h√†m
                        } catch (err) {
                            console.error("‚ùå L·ªói khi x√°c nh·∫≠n v√©:", err);
                            alert("‚ö†Ô∏è L·ªói x√°c nh·∫≠n v√©. Vui l√≤ng ki·ªÉm tra email ho·∫∑c v√†o m·ª•c V√© c·ªßa b·∫°n.");
                        }
                    }


                } else {
                    // üî∏ N·∫øu ch∆∞a th·∫•y giao d·ªãch, hi·ªÉn th·ªã tr·∫°ng th√°i ch·ªù
                    statusEl.textContent = `‚è≥ ƒêang ch·ªù giao d·ªãch... (${tries}/${maxTries})`;
                    statusEl.style.color = 'orange';
                }


                // üïí H·∫øt th·ªùi gian ch·ªù
                if (tries >= maxTries) {
                    clearInterval(interval);
                    statusEl.textContent = '‚ùå H·∫øt th·ªùi gian ch·ªù.';
                    statusEl.style.color = 'red';
                    alert("‚è∞ H·∫øt th·ªùi gian ch·ªù. Vui l√≤ng ki·ªÉm tra l·∫°i giao d·ªãch ho·∫∑c th·ª≠ l·∫°i sau.");
                }
            } catch (e) {
                console.error("‚ùå L·ªói polling tr·∫°ng th√°i:", e);
                statusEl.textContent = '‚ö†Ô∏è L·ªói k·∫øt n·ªëi.';
                statusEl.style.color = 'red';
            }
        }, pollInterval);
    }




</script>


</body>
</html>

