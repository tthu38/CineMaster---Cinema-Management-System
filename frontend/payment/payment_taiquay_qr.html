<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <title>Thanh to√°n QR VietQR - CineMaster</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@5/dark.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            background: #071226;
            color: #e6f1ff;
            font-family: 'Roboto', Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .card {
            width: 100%;
            max-width: 520px;
            border-radius: 14px;
            padding: 22px;
            background: linear-gradient(180deg, #071226 0%, #081731 100%);
            box-shadow: 0 10px 30px rgba(0, 0, 0, .6);
            border: 1px solid rgba(255, 255, 255, .03);
        }
        .qr { text-align:center; margin-top:12px; }
        .muted { color:#9fb0c8; font-size:0.95rem; }
        .staff-section { margin-top: 25px; border-top: 1px solid #1c2741; padding-top: 15px; text-align:center; }
        .btn-confirm { background: #22c55e; border: none; font-weight: 600; color: white; }
        .btn-confirm:hover { background: #16a34a; }
    </style>
</head>
<body>
<div class="card">
    <h4 class="mb-3">üí≥ Thanh to√°n QR VietQR</h4>

    <div class="mb-3">
        <label class="form-label">S·ªë ti·ªÅn (VNƒê)</label>
        <input id="amount" type="number" class="form-control" placeholder="Nh·∫≠p s·ªë ti·ªÅn c·∫ßn thanh to√°n..." />
    </div>

    <div class="mb-3">
        <label class="form-label">N·ªôi dung chuy·ªÉn kho·∫£n (optional)</label>
        <input id="note" type="text" class="form-control" placeholder="V√≠ d·ª•: THANH_TOAN_CINEMA" />
    </div>

    <button id="btnGenerate" class="btn btn-info w-100 mb-3">T·∫°o m√£ QR thanh to√°n</button>

    <div id="qrContainer" class="qr"></div>

    <!-- ‚úÖ Ph·∫ßn x√°c nh·∫≠n t·∫°i qu·∫ßy -->
    <div id="staffSection" class="staff-section" style="display:none;">
        <h6 class="text-info mb-3">üßæ X√°c nh·∫≠n thanh to√°n t·∫°i qu·∫ßy</h6>
        <button id="btnConfirm" class="btn btn-confirm px-4 py-2">‚úÖ ƒê√É NH·∫¨N ƒê∆Ø·ª¢C TI·ªÄN</button>
    </div>
</div>

<script>
    const API_URL = "http://localhost:8080/api/v1/merchant/default";
    let merchant = null;

    async function loadMerchant() {
        try {
            const res = await fetch(API_URL);
            if (!res.ok) throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c t√†i kho·∫£n");
            merchant = await res.json();
            console.log("Merchant info:", merchant);
        } catch (err) {
            alert("Kh√¥ng th·ªÉ t·∫£i th√¥ng tin t√†i kho·∫£n thanh to√°n!");
            console.error(err);
        }
    }

    async function generateQR() {
        if (!merchant) {
            alert("Kh√¥ng c√≥ th√¥ng tin t√†i kho·∫£n ƒë·ªÉ t·∫°o QR!");
            return;
        }

        const amount = document.getElementById("amount").value;
        if (!amount || amount <= 0) {
            alert("Nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá!");
            return;
        }

        const note = document.getElementById("note").value.trim() || "THANH_TOAN_CINEMA";
        const ref = "CM-" + Date.now().toString().slice(-6);

        const qrUrl =
            `https://img.vietqr.io/image/${merchant.bankCode}-${merchant.accountNumber}-compact.png` +
            `?amount=${amount}&addInfo=${encodeURIComponent(note + ' ' + ref)}` +
            `&accountName=${encodeURIComponent(merchant.accountName)}`;

        document.getElementById("qrContainer").innerHTML = `
      <h5 class="text-success">Qu√©t m√£ ƒë·ªÉ thanh to√°n</h5>
      <img src="${qrUrl}" width="260" alt="QR thanh to√°n">
      <p class="mt-2 small">üí° STK: <b>${merchant.accountNumber}</b> (${merchant.bankCode})<br>T√™n: <b>${merchant.accountName}</b></p>
      <p class="text-warning">S·ªë ti·ªÅn: ${Number(amount).toLocaleString()} ƒë</p>
      <p class="muted small">N·ªôi dung: ${note} ${ref}</p>
    `;

        // üîπ Hi·ªán ph·∫ßn x√°c nh·∫≠n t·∫°i qu·∫ßy
        document.getElementById("staffSection").style.display = "block";
    }

    document.getElementById("btnGenerate").addEventListener("click", generateQR);

    // ‚úÖ Khi nh√¢n vi√™n nh·∫•n "ƒê√É NH·∫¨N ƒê∆Ø·ª¢C TI·ªÄN"
    document.getElementById("btnConfirm").addEventListener("click", () => {
        Swal.fire({
            icon: 'success',
            title: 'üíµ Thanh to√°n th√†nh c√¥ng!',
            text: 'Giao d·ªãch ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n t·∫°i qu·∫ßy.',
            confirmButtonText: 'Ho√†n t·∫•t',
            confirmButtonColor: '#22c55e'
        });
        document.getElementById("btnConfirm").disabled = true;
        document.getElementById("btnConfirm").innerText = "‚úÖ ƒê√É X√ÅC NH·∫¨N";
    });

    loadMerchant();
</script>
</body>
</html>
