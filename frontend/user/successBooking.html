<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>ƒê·∫∑t v√© th√†nh c√¥ng - CineMaster</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            background-color: #06101f;
            color: #e6f1ff;
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card-custom {
            background: rgba(8, 20, 40, 0.5);
            border: 1px solid rgba(34, 193, 255, 0.25);
            border-radius: 18px;
            padding: 30px;
            backdrop-filter: blur(10px);
            width: 100%;
            max-width: 600px;
            box-shadow: 0 0 25px rgba(0, 163, 255, 0.2);
        }
        .btn-cyan {
            background: linear-gradient(90deg, #0aa3ff, #22c1ff);
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 10px;
            padding: 10px 30px;
        }
    </style>
</head>
<body>
<div class="card-custom text-center">
    <i class="fa-solid fa-circle-check text-success fa-5x mb-4"></i>
    <h3 class="fw-bold text-light mb-3">üéâ ƒê·∫∑t v√© th√†nh c√¥ng!</h3>
    <p class="text-info mb-4">Th√¥ng tin v√© c·ªßa b·∫°n ƒë∆∞·ª£c hi·ªÉn th·ªã b√™n d∆∞·ªõi. C·∫£m ∆°n b·∫°n ƒë√£ ƒë·∫∑t v√© t·∫°i CineMaster!</p>

    <div id="ticketDetail" class="text-start bg-dark bg-opacity-25 p-3 rounded mb-3"></div>

    <button class="btn-cyan" onclick="window.location.href='../home/index.html'">
        Quay l·∫°i trang ch·ªß
    </button>
</div>

<script type="module">
    import { showtimeApi } from "../js/api/showtimeApi.js";
    import { movieApi } from "../js/api/movieApi.js";
    import { branchApi } from "../js/api/branchApi.js";
    import { API_BASE_URL } from "../js/api/config.js";

    // üéüÔ∏è L·∫•y d·ªØ li·ªáu v√© ƒë√£ l∆∞u t·∫°m
    const data = JSON.parse(localStorage.getItem("successBookingData") || "{}");
    const ticketId = Number(localStorage.getItem("tempTicketId") || 0);

    if (!data.showtimeId || !ticketId) {
        document.getElementById("ticketDetail").innerHTML =
            "<p class='text-danger'>Kh√¥ng t√¨m th·∫•y th√¥ng tin v√©!</p>";
        throw new Error("Thi·∫øu d·ªØ li·ªáu ƒë·∫∑t v√©");
    }

    /* ==================== üîπ LOAD TH√îNG TIN V√â ==================== */
    async function loadSuccessInfo() {
        try {
            // --- L·∫•y su·∫•t chi·∫øu + phim + chi nh√°nh ---
            const showtimeRes = await showtimeApi.getPublicById(data.showtimeId);
            const showtime = showtimeRes?.result || showtimeRes;

            const movieRes = await movieApi.getById(showtime.movieId || showtime.period.movieId);
            const movie = movieRes?.result || movieRes;

            const branchRes = await branchApi.getById(data.branchId);
            const branch = branchRes?.result || branchRes;

            const date = new Date(showtime.startTime);
            const dateStr = date.toLocaleDateString("vi-VN", {
                weekday: "long",
                day: "2-digit",
                month: "2-digit",
                year: "numeric"
            });
            const timeStr = date.toLocaleTimeString("vi-VN", {
                hour: "2-digit",
                minute: "2-digit"
            });

            // --- Render chi ti·∫øt v√© ---
            document.getElementById("ticketDetail").innerHTML = `
      <div><b>üé¨ Phim:</b> ${movie.title}</div>
      <div><b>üè† Chi nh√°nh:</b> ${branch.name}</div>
      <div><b>üïì Su·∫•t chi·∫øu:</b> ${dateStr} - ${timeStr}</div>
      <div><b>üí∫ Gh·∫ø:</b> ${data.seatIds?.join(", ")}</div>
      <div><b>üéÅ M√£ gi·∫£m gi√°:</b> ${data.discountCode || "Kh√¥ng c√≥"}</div>
      <div><b>üîª Gi·∫£m:</b> ${data.discountAmount?.toLocaleString("vi-VN") || 0} VNƒê</div>
      <hr>
      <div><b>üéüÔ∏è V√©:</b> ${data.ticketTotal?.toLocaleString("vi-VN") || 0} VNƒê</div>
      <div><b>ü•§ Combo:</b> ${data.comboTotal?.toLocaleString("vi-VN") || 0} VNƒê</div>
      <div class="fw-bold text-info mt-2"><b>T·ªïng c·ªông:</b> ${data.grandTotal?.toLocaleString("vi-VN") || 0} VNƒê</div>
      <div class="mt-2"><b>üìß G·ª≠i v√© ƒë·∫øn:</b> ${data.email}</div>
      <div id="emailStatus" class="mt-3 text-warning">‚è≥ ƒêang x√°c nh·∫≠n v√© v√† g·ª≠i email...</div>
    `;

            // --- X√°c nh·∫≠n v√© + g·ª≠i email ---
            await confirmTicketAndSendMail();

        } catch (err) {
            console.error("‚ùå L·ªói t·∫£i th√¥ng tin v√©:", err);
            document.getElementById("ticketDetail").innerHTML =
                `<p class='text-danger'>Kh√¥ng th·ªÉ t·∫£i th√¥ng tin v√©!</p>`;
        }
    }

    /* ==================== üì© G·ªåI API X√ÅC NH·∫¨N V√â ==================== */
    async function confirmTicketAndSendMail() {
        const emailStatus = document.getElementById("emailStatus");
        try {
            const token = localStorage.getItem("accessToken");

            // ‚ö†Ô∏è N·∫øu ch∆∞a c√≥ token ‚Üí hi·ªÉn th·ªã l·ªói thay v√¨ g·ª≠i request 403
            if (!token) {
                emailStatus.classList.remove("text-warning");
                emailStatus.classList.add("text-danger");
                emailStatus.innerHTML = "‚ö†Ô∏è B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ x√°c nh·∫≠n v√©.";
                return;
            }

            const res = await fetch(`${API_BASE_URL}/tickets/${ticketId}/confirm`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ email: data.email })
            });

            if (res.status === 403) {
                throw new Error("B·∫°n kh√¥ng c√≥ quy·ªÅn x√°c nh·∫≠n v√© (403)");
            }
            if (!res.ok) {
                throw new Error("L·ªói x√°c nh·∫≠n v√© (status " + res.status + ")");
            }

            const result = await res.json();
            console.log("‚úÖ V√© ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n:", result);

            emailStatus.classList.remove("text-warning");
            emailStatus.classList.add("text-success");
            emailStatus.innerHTML = "‚úÖ V√© ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n v√† email ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!";
        } catch (err) {
            console.error("‚ùå L·ªói g·ª≠i mail x√°c nh·∫≠n:", err);
            emailStatus.classList.remove("text-warning");
            emailStatus.classList.add("text-danger");
            emailStatus.innerHTML = "‚ùå Kh√¥ng th·ªÉ g·ª≠i email x√°c nh·∫≠n v√©! (" + err.message + ")";
        }
    }

    /* ==================== üöÄ KH·ªûI CH·∫†Y ==================== */
    await loadSuccessInfo();
</script>


</body>
</html>
