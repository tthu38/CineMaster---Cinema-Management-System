<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Ch·ªçn Gh·∫ø - CineMaster</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- FONT & ICON -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root{
            --red:#CE2F26;
            --ink:#06101f;
            --bg:#091425;
            --card:#0e1c31;
            --border:#1b2b4a;
            --text-light:#e6f1ff;
            --text-muted:#9aa7b3;
            --vip-color: #8c00ff;
            --couple-color: #0aa3ff;
            --hold-color: #ffc107;
        }

        html,body{
            margin:0;
            font-family:'Roboto',sans-serif;
            color:#fff;
            height:auto;
            overflow-y:auto;
            background-color:var(--ink);
            background-image:
                    radial-gradient(1200px 600px at -10% -35%, rgba(206,47,38,.18), transparent 60%),
                    radial-gradient(900px 400px at 120% -20%, rgba(34,193,255,.12), transparent 60%),
                    linear-gradient(180deg, var(--ink), var(--bg));
            background-repeat:no-repeat,no-repeat,no-repeat;
            background-size:1200px 600px,900px 400px,100% 100%;
            background-position:-10% -35%,120% -20%,0 0;
            background-attachment:fixed,fixed,fixed;
        }

        /* Hide scrollbar for webkit browsers */
        .info-panel::-webkit-scrollbar,
        .seat-panel::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for Firefox */
        .info-panel,
        .seat-panel {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        /* üéüÔ∏è Tickets background */
        .tickets-wall{
            position:fixed; inset:0; pointer-events:none; z-index:5;
        }
        .tickets-wall .tickets-layer{
            position:absolute; inset:-10%;
            background-repeat:repeat;
            background-size:320px 160px;
            opacity:.14;
            filter:drop-shadow(0 0 20px rgba(22,40,76,.18));
            transform-origin:center center;
        }
        .tickets-wall .l1{
            transform:rotate(-3deg) scale(1.04);
            background-image:url("data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='160' viewBox='0 0 320 160'%3E%3Crect fill='none' width='320' height='160'/%3E%3Cg opacity='0.95'%3E%3Cg transform='translate(8,8)'%3E%3Cpath d='M0 24 a12 12 0 0 1 12 -12 h200 a10 10 0 0 0 10 -10 a12 12 0 0 1 12 12 v60 a12 12 0 0 1 -12 12 a10 10 0 0 0 -10 10 H12 a12 12 0 0 1 -12 -12z' fill='%23192A43' stroke='%232c3e66' stroke-width='2'/%3E%3Cline x1='140' y1='12' x2='140' y2='96' stroke='%238fb4ff' stroke-opacity='0.18' stroke-dasharray='6 6' /%3E%3Ccircle cx='60' cy='54' r='22' fill='none' stroke='%238fb4ff' stroke-opacity='0.35' stroke-width='3'/%3E%3Ccircle cx='60' cy='54' r='5' fill='%238fb4ff' opacity='0.3'/%3E%3Cg fill='%238fb4ff' opacity='0.35'%3E%3Ccircle cx='49' cy='44' r='5'/%3E%3Ccircle cx='71' cy='44' r='5'/%3E%3Ccircle cx='49' cy='64' r='5'/%3E%3Ccircle cx='71' cy='64' r='5'/%3E%3C/g%3E%3Cg transform='translate(164,32)' stroke='%23cfe3ff' stroke-opacity='0.38'%3E%3Crect x='0' y='0' width='60' height='24' fill='none'/%3E%3Cpath d='M3 0 v24 M8 0 v24 M11 0 v24 M16 0 v24 M22 0 v24 M27 0 v24 M33 0 v24 M38 0 v24 M45 0 v24 M51 0 v24 M56 0 v24' stroke-width='2'/%3E%3C/g%3E%3Cg transform='translate(164,66)' stroke='%23cfe3ff' stroke-opacity='0.45'%3E%3Cline x1='0' y1='0' x2='76' y2='0' stroke-width='2'/%3E%3Cline x1='0' y1='10' x2='62' y2='10' stroke-width='2'/%3E%3Cline x1='0' y1='20' x2='70' y2='20' stroke-width='2'/%3E%3C/g%3E%3C/g%3E%3Cg transform='translate(8,88)'%3E%3Cpath d='M0 24 a12 12 0 0 1 12 -12 h200 a10 10 0 0 0 10 -10 a12 12 0 0 1 12 12 v60 a12 12 0 0 1 -12 12 a10 10 0 0 0 -10 10 H12 a12 12 0 0 1 -12 -12z' fill='%231b2f50' stroke='%23314774' stroke-width='2'/%3E%3Cline x1='140' y1='12' x2='140' y2='96' stroke='%238fb4ff' stroke-opacity='0.18' stroke-dasharray='6 6'/%3E%3Ccircle cx='60' cy='54' r='22' fill='none' stroke='%23a8c8ff' stroke-opacity='0.32' stroke-width='3'/%3E%3Ccircle cx='60' cy='54' r='5' fill='%23a8c8ff' opacity='0.28'/%3E%3Cg fill='%23a8c8ff' opacity='0.32'%3E%3Ccircle cx='49' cy='44' r='5'/%3E%3Ccircle cx='71' cy='44' r='5'/%3E%3Ccircle cx='49' cy='64' r='5'/%3E%3Ccircle cx='71' cy='64' r='5'/%3E%3C/g%3E%3Cg transform='translate(164,32)' stroke='%23d8e6ff' stroke-opacity='0.38'%3E%3Cpath d='M3 0 v24 M8 0 v24 M11 0 v24 M16 0 v24 M22 0 v24 M27 0 v24 M33 0 v24 M38 0 v24 M45 0 v24 M51 0 v24 M56 0 v24' stroke-width='2'/%3E%3C/g%3E%3Cg transform='translate(164,66)' stroke='%23d8e6ff' stroke-opacity='0.45'%3E%3Cline x1='0' y1='0' x2='76' y2='0' stroke-width='2'/%3E%3Cline x1='0' y1='10' x2='62' y2='10' stroke-width='2'/%3E%3Cline x1='0' y1='20' x2='70' y2='20' stroke-width='2'/%3E%3C/g%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .tickets-wall .l2{
            transform:rotate(3deg) scale(1.06);
            background-position:160px 80px;
            opacity:.10;
            background-image:inherit;
        }

        /* üåå Grain */
        .grain {
            pointer-events: none;
            position: fixed; inset: 0;
            opacity: .14;
            mix-blend-mode: screen;
            background-image:
                    radial-gradient(circle at 20% 30%, rgba(255,255,255,.06) 0 2px, transparent 2px),
                    radial-gradient(circle at 70% 60%, rgba(255,255,255,.05) 0 2px, transparent 2px);
            background-size: 200px 200px, 260px 260px;
            animation: drift 18s linear infinite alternate;
            z-index: 5;
        }
        @keyframes drift {
            from { transform: translate3d(0,0,0) }
            to { transform: translate3d(30px,-25px,0) }
        }

        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px 0;
            gap: 10px;
        }

        /* ========== LAYOUT ========== */
        .booking-container {
            display: flex;
            width: 150%;
            max-width: 1100px;
            height: 70%;
            background: rgba(12, 22, 44, 0.15);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(34, 193, 255, 0.2);
            border-radius: 18px;
            box-shadow: 0 14px 32px rgba(0, 0, 0, .5);
            overflow: hidden;
            position: relative;
            z-index: 10;
            margin-bottom: 10px;
        }

        /* ===== PANEL TR√ÅI ===== */
        .info-panel {
            flex: 0 0 320px;
            background: rgba(8, 20, 40, 0.45);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 30px 20px;
            border-left: 1px solid rgba(34, 193, 255, 0.25);
            position: relative;
            overflow: hidden;
            overflow-y: visible;
        }
        .info-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 80% 80%, rgba(206,47,38,0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        .movie-title-large {
            font-size: 1.8rem;
            font-weight: 900;
            text-transform: uppercase;
            background: linear-gradient(45deg, var(--red), #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        .showtime-details {
            color: var(--text-muted);
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        .section-title {
            color: var(--red);
            font-weight: 700;
            border-bottom: 2px solid var(--red);
            margin-top: 25px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            position: relative;
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 30px;
            height: 2px;
            background: linear-gradient(90deg, var(--red), transparent);
        }
        .seat-item {
            border-bottom: 1px dashed rgba(255,255,255,0.1);
            padding: 8px 0;
            transition: background 0.2s;
        }
        .seat-item:hover {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding-left: 5px;
        }
        .total-summary {
            border-top: 1px solid var(--border);
            margin-top: 20px;
            padding-top: 20px;
        }
        .btn-continue {
            background: linear-gradient(45deg, var(--red), #b8211c);
            border: none;
            box-shadow: 0 4px 15px rgba(206,47,38,0.3);
            transition: all 0.3s ease;
        }
        .btn-continue:hover {
            background: linear-gradient(45deg, #b8211c, var(--red));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(206,47,38,0.4);
        }
        .btn-outline-secondary {
            border-color: var(--border);
            color: var(--text-muted);
            transition: all 0.3s;
        }
        .btn-outline-secondary:hover {
            background: var(--border);
            color: var(--text-light);
        }

        /* ===== PANEL PH·∫¢I ===== */
        .seat-panel {
            flex-grow: 1;
            padding: 30px;
            text-align: center;
            background: rgba(8, 20, 40, 0.45);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            overflow-y: visible;
        }
        .seat-panel h2 {
            background: linear-gradient(45deg, var(--red), #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.6rem;
            margin-bottom: 0px;
            text-shadow: 0 2px 10px rgba(206,47,38,0.3);
        }
        .screen-container {
            perspective: 1000px;
            margin-bottom: 30px;
        }
        .screen {
            background: linear-gradient(90deg, #1b2b4a, #e6f1ff, #1b2b4a);
            height: 15px;
            width: 85%;
            margin: 0 auto;
            transform: rotateX(-30deg) scale(1.05);
            box-shadow: 0 8px 30px rgba(34,193,255,0.5), inset 0 2px 4px rgba(255,255,255,0.2);
            border-radius: 5px;
            position: relative;
        }
        .screen::after {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #e6f1ff;
        }
        .screen-text {
            color: var(--text-muted);
            margin-top: 20px;
            letter-spacing: 3px;
            text-transform: uppercase;
            font-weight: 500;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* ===== GH·∫æ V√Ä D√ÉY GH·∫æ - C·∫¢I THI·∫æN THI·∫æT K·∫æ ===== */
        #seatMap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            max-width: 85%;
            margin-left: auto;
            margin-right: auto;
            padding: 10px;
            background: rgba(0,0,0,0.1);
            border-radius: 12px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
        }
        .row-container {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            width: 100%;
            justify-content: center;
        }
        .row-label {
            min-width: 35px;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-light);
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            flex-shrink: 0;
            background: linear-gradient(135deg, var(--border), var(--card));
            padding: 5px 8px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .row-seats {
            display: flex;
            gap: 6px;
            padding: 5px 0;
        }
        .aisle {
            flex: 0 0 80px;
            min-width: 80px;
        }
        .seat {
            width: 32px;
            height: 32px;
            border-radius: 8px 8px 2px 2px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-light);
            border: 2px solid var(--border);
            background-color: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
            transform: perspective(500px) rotateX(10deg);
        }
        .seat:hover {
            transform: perspective(500px) rotateX(0deg) scale(1.05) translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,255,255,0.1), inset 0 1px 0 rgba(255,255,255,0.15);
        }
        .seat.selected {
            background-color: #e50914 !important;
            border: 2px solid #ffdddd;
            transform: scale(1.05);
        }
        .seat.vip {
            background: linear-gradient(135deg, var(--vip-color), #a100ff);
            border-color: var(--vip-color);
            box-shadow: 0 0 10px rgba(140,0,255,0.5), inset 0 1px 0 rgba(255,255,255,0.1);
        }
        .seat.couple {
            background: linear-gradient(135deg, var(--couple-color), #00aaff);
            border-color: var(--couple-color);
            width: 68px;
            font-size: 0.65rem;
            box-shadow: 0 0 10px rgba(10,163,255,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
        }
        .seat.booked, .seat.reserved, .seat.broken {
            background-color: #333 !important;
            color: #777;
            cursor: not-allowed;
            border-color: #555;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.05);
            transform: perspective(500px) rotateX(10deg) scale(0.95);
        }
        .seat.booked::after {
            content: 'X';
            position: absolute;
            top: 2px;
            right: 2px;
            color: #ff4444;
            font-weight: bold;
            font-size: 0.8rem;
        }

        /* ===== LEGEND ===== */
        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 30px;
            border-top: 1px solid var(--border);
            padding-top: 15px;
        }
        .legend div {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            transition: background 0.3s;
        }
        .legend div:hover {
            background: rgba(255,255,255,0.1);
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .movie-poster {
            width: 80%;
            max-width: 160px;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.1), 0 0 30px rgba(206,47,38,0.2);
            border: 3px solid var(--border);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        .movie-poster::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(206,47,38,0.1) 50%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
        }
        .movie-poster:hover {
            transform: scale(1.08) rotate(2deg);
            box-shadow: 0 20px 50px rgba(206,47,38,0.4);
        }
        .movie-poster:hover::before {
            opacity: 1;
        }

        /* ===== COMBO MODAL STYLES ===== */
        .combo-header {
            background: linear-gradient(135deg, var(--red), #ff6b6b);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 15px 15px 0 0;
            margin: -1rem -1rem 1rem -1rem;
        }
        .combo-header .movie-name {
            font-size: 1.5rem;
            font-weight: 900;
            margin-bottom: 5px;
        }
        .combo-header .promo {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        .combo-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        .combo-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        .combo-image {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            object-fit: cover;
            margin-right: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .combo-details {
            flex-grow: 1;
        }
        .combo-code {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }
        .combo-name {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .combo-price {
            font-size: 1.2rem;
            font-weight: 900;
            color: #ffd700;
            margin-bottom: 10px;
        }
        .combo-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .combo-qty-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid #fff;
            background: transparent;
            color: #fff;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .combo-qty-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        .combo-qty-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .combo-qty {
            min-width: 30px;
            text-align: center;
            font-weight: 700;
            color: #fff;
        }
        .combo-footer {
            text-align: center;
            padding: 10px;
            color: var(--text-muted);
            font-size: 0.9rem;
            border-top: 1px solid var(--border);
            margin-top: 15px;
        }

        /* ========== BOOKING PROGRESS ========== */
        .booking-progress {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            margin-bottom: 20px;
            position: relative;
            /*padding: 5px 0;*/
            z-index: 10;
            background: rgba(12, 22, 44, 0.3);
            border-bottom: 1px solid rgba(34, 193, 255, 0.1);
            width: 70%;
            max-width: 950px;
            border-radius: 18px 18px 0 0;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-muted);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .progress-step.active {
            color: var(--text-light);
            font-weight: bold;
        }

        .progress-step.completed {
            color: #22c55e;
        }

        .progress-line {
            width: 60px;
            height: 3px;
            background: var(--border);
            border-radius: 2px;
            transition: background 0.3s;
        }

        .progress-step.active ~ .progress-line {
            background: var(--red);
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--border);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
            transition: all 0.3s;
        }

        .progress-step.active .step-icon {
            background: linear-gradient(45deg, var(--red), #b8211c);
            border-color: var(--red);
            box-shadow: 0 0 10px rgba(206,47,38,0.6);
        }

        /* ƒêi·ªÅu ch·ªânh padding cho panels ƒë·ªÉ tr√°nh overlap v·ªõi progress */
        .info-panel, .seat-panel {
            padding-top: 20px;
        }

        #footer {
            position: relative;
            z-index: 20;
            width: 100%;
            background: rgba(8, 15, 30, 0.95);
            color: #cfe3ff;
            padding-top: 40px;
            border-top: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 -4px 15px rgba(0,0,0,0.3);
        }

        #footer a {
            color: #cfe3ff;
            text-decoration: none;
            transition: color 0.3s;
        }
        #footer a:hover {
            color: #22c1ff;
        }

        .seat.holding {
            background: linear-gradient(135deg, #ff5555, #cc0000) !important;
            border-color: #ff5555;
            color: #fff;
            cursor: not-allowed;
            box-shadow: 0 0 10px rgba(255,0,0,0.6);
        }

        .seat.vip { background-color: #8000ff; }  /* t√≠m */
        .seat.selected { background-color: #e50914; }  /* ƒë·ªè */


        .seat.selected,
        .seat.vip.selected,
        .seat.couple.selected {
            background-color: #e50914 !important;
            border-color: #ffdddd !important;
            transform: scale(1.05);
        }

        .seat.selected {
            animation: pulse 0.3s ease;
        }

        @keyframes pulse {
            0% { transform: scale(0.9); }
            100% { transform: scale(1.05); }
        }


        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 5px 0;
                gap: 5px;
            }
            .booking-container {
                flex-direction: column;
                width: 95%;
                max-width: none;
                height: calc(100vh - 100px);
            }
            .booking-progress {
                width: 95%;
            }
            .info-panel {
                flex: none;
                border-left: none;
                border-bottom: 1px solid var(--border);
                flex: 0 0 auto;
            }
            .row-seats {
                gap: 4px;
            }
            .aisle {
                flex: 0 0 60px;
                min-width: 60px;
            }
            .seat {
                width: 28px;
                height: 28px;
            }
            .seat.couple {
                width: 56px;
            }
            .row-label {
                min-width: 25px;
                font-size: 0.9rem;
                width: 30px;
                height: 30px;
            }
            .combo-item {
                flex-direction: column;
                text-align: center;
            }
            .combo-image {
                margin-right: 0;
                margin-bottom: 10px;
            }
            .info-panel, .seat-panel {
                padding-top: 15px;
            }
        }
    </style>
</head>

<body>
<div id="header"></div>

<div class="grain"></div>
<div class="tickets-wall" aria-hidden="true">
    <div class="tickets-layer l1"></div>
    <div class="tickets-layer l2"></div>
</div>

<!-- üß≠ Booking Progress Bar -->
<div class="booking-progress">
    <div class="progress-step active">
        <div class="step-icon"><i class="fas fa-chair"></i></div>
        <span>Ch·ªçn Gh·∫ø</span>
    </div>
    <div class="progress-line"></div>
    <div class="progress-step">
        <div class="step-icon"><i class="fas fa-popcorn"></i></div>
        <span>Ch·ªçn Combo</span>
    </div>
    <div class="progress-line"></div>
    <div class="progress-step">
        <div class="step-icon"><i class="fas fa-credit-card"></i></div>
        <span>Thanh To√°n</span>
    </div>
</div>

<div class="booking-container">
    <!-- RIGHT PANEL (now left after swap) -->
    <div class="seat-panel">
        <h2 class="fw-bold mb-3">CH·ªåN V·ªä TR√ç C·ª¶A B·∫†N</h2>
        <div class="screen-container">
            <div class="screen"></div>
            <div class="screen-text">M√ÄN H√åNH</div>
        </div>
        <div id="seatMap"></div>

        <div class="legend">
            <div class="d-flex align-items-center"><div class="legend-color" style="background-color: var(--bg);"></div>Th∆∞·ªùng</div>
            <div class="d-flex align-items-center"><div class="legend-color" style="background-color: var(--vip-color);"></div>VIP</div>
            <div class="d-flex align-items-center"><div class="legend-color" style="background-color: var(--couple-color);"></div>ƒê√¥i</div>
            <div class="d-flex align-items-center"><div class="legend-color" style="background-color: #333;"></div>ƒê√£ ƒë·∫∑t</div>
        </div>
    </div>

    <!-- LEFT PANEL (now right after swap) -->
    <div class="info-panel">
        <div class="movie-title-large" id="movieTitle">ƒêang t·∫£i...</div>
        <div class="showtime-details" id="movieInfo">--</div>

        <div class="poster-wrapper text-center mb-3">
            <img id="moviePoster" src="" alt="Poster phim" class="movie-poster">
        </div>

        <div class="section-title">Gh·∫ø ƒë√£ ch·ªçn</div>
        <ul id="selectedList" class="list-unstyled"></ul>

        <div class="total-summary">
            <div class="d-flex justify-content-between align-items-center">
                <span class="h5 fw-bold">T·ªïng c·ªông:</span>
                <span id="totalDisplay" class="h5 fw-bold text-warning">0 VNƒê</span>
            </div>
            <button id="confirmBtn" class="btn btn-continue w-100 mt-3 fw-bold btn-lg">
                ƒê·∫∂T V√â <i class="fas fa-ticket-alt ms-2"></i>
            </button>
            <button class="btn btn-outline-secondary w-100 mt-2" onclick="window.history.back()">H·ª¶Y B·ªé</button>
        </div>
    </div>
</div>

<div id="footer" style="position: relative; z-index: 20;"></div>


<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
    import { seatTypeApi } from "../js/api.js";
    import { seatApi } from "../js/api/seatApi.js";
    import { showtimeApi } from "../js/api/showtimeApi.js";
    import { API_BASE_URL } from "../js/api/config.js";

    const seatMap = document.getElementById("seatMap");
    const movieInfo = document.getElementById("movieInfo");
    const movieTitle = document.getElementById("movieTitle");
    const confirmBtn = document.getElementById("confirmBtn");
    const selectedList = document.getElementById("selectedList");
    const totalDisplay = document.getElementById("totalDisplay");
    const posterEl = document.getElementById("moviePoster");

    const params = new URLSearchParams(window.location.search);
    const showtimeId = params.get("showtimeId");
    const accountId = localStorage.getItem("accountId") || params.get("accountId") || 1;
    let ticketId = params.get("ticketId");
    let tempTicketId = localStorage.getItem("tempTicketId");

    let auditoriumId = null;
    let branchId = null;
    let seatTypes = [];
    let allSeats = [];
    let selectedSeats = [];

    const formatSeatNumber = n => n || "";
    const getRowLetter = row => row ? row.replace(/[0-9]/g, "").slice(-1).toUpperCase() : "";

    /* ================= LOAD D·ªÆ LI·ªÜU ================= */
    async function loadSeatTypes() {
        try { seatTypes = await seatTypeApi.getAll(); } catch (e) { seatTypes = []; }
    }

    async function loadShowtime() {
        const st = await showtimeApi.getById(showtimeId);
        auditoriumId = st.auditoriumId || st.auditorium?.auditoriumID;
        branchId = st.branchId || st.auditorium?.branch?.branchID;
        window.currentShowtime = st;

        movieTitle.textContent = st.movieTitle || "Kh√¥ng r√µ t√™n phim";
        movieInfo.innerHTML = `
            <i class="far fa-clock"></i> ${new Date(st.startTime).toLocaleTimeString("vi-VN", {hour: "2-digit", minute: "2-digit"})} |
            <i class="fas fa-calendar-alt"></i> ${new Date(st.startTime).toLocaleDateString("vi-VN")} |
            Ph√≤ng ${st.auditoriumName || auditoriumId}
        `;
        posterEl.src = st.posterUrl ? (st.posterUrl.startsWith("http") ? st.posterUrl : `/${st.posterUrl.replace(/^\/+/, "")}`) : "/img/default-poster.jpg";

        await loadSeats(false);
    }

    /* ================= LOAD GH·∫æ ================= */
    /* ================= LOAD GH·∫æ ================= */
    async function loadSeats(isRefresh = false) {
        try {
            allSeats = await seatApi.getByAuditorium(auditoriumId);

            // üîπ L·∫•y danh s√°ch gh·∫ø ƒë√£ gi·ªØ ho·∫∑c ƒë√£ ƒë·∫∑t (HOLDING/BOOKED)
            let occupiedSeatIds = [];
            try {
                const occupiedRes = await fetch(`${API_BASE_URL}/tickets/occupied/${showtimeId}`);
                if (occupiedRes.ok) {
                    occupiedSeatIds = await occupiedRes.json();
                }
            } catch (err) {
                console.warn("‚ö†Ô∏è Kh√¥ng th·ªÉ load gh·∫ø ƒëang gi·ªØ t·ª´ server:", err);
            }

            const restoreId = ticketId || localStorage.getItem("tempTicketId");
            let mySeatIds = [];

            // üîπ Restore t·ª´ localStorage
            if (!isRefresh) {
                const localTempStr = localStorage.getItem("tempTicket");
                if (localTempStr) {
                    const localTemp = JSON.parse(localTempStr);
                    if (localTemp?.ticketId && localTemp.ticketStatus === "HOLDING") {
                        const hu = new Date(localTemp.holdUntil);
                        if (hu > new Date()) {
                            mySeatIds = localTemp.ticketSeats?.map(s => s.seat?.seatID) || [];
                            localStorage.setItem("tempTicketId", localTemp.ticketId);
                            console.log("üîÅ Restore t·ª´ local:", mySeatIds);
                        }
                    }
                }
            }

            // üîπ N·∫øu ch∆∞a c√≥ ‚Üí restore t·ª´ server
            if (mySeatIds.length === 0 && restoreId) {
                const token = localStorage.getItem("accessToken");
                try {
                    const res = await fetch(`${API_BASE_URL}/tickets/${restoreId}`, {
                        headers: { "Authorization": `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const t = await res.json();
                        if (t.status === "HOLDING") {
                            mySeatIds = t.seatIds || [];
                            localStorage.setItem("tempTicketId", t.ticketId);
                            localStorage.setItem("tempTicket", JSON.stringify(t));

                            // refresh hold ƒë·ªÉ gi·ªØ gh·∫ø h·ª£p l·ªá
                            if (mySeatIds.length > 0) {
                                const body = {
                                    accountId: Number(accountId),
                                    showtimeId: Number(showtimeId),
                                    seatIds: mySeatIds,
                                    ticketId: Number(restoreId)
                                };
                                await fetch(`${API_BASE_URL}/tickets`, {
                                    method: "POST",
                                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                                    body: JSON.stringify(body)
                                });
                                console.log("üîÑ Gia h·∫°n holdUntil cho ticket", restoreId);
                            }
                        }
                    }
                } catch (err) { console.error(err); }
            }

            // üîπ N·∫øu l√† refresh t·ª± ƒë·ªông 8s ‚Üí gi·ªØ nguy√™n gh·∫ø m√¨nh ƒëang ch·ªçn
            if (isRefresh && selectedSeats.length > 0) {
                console.log("üß≠ Refresh nh·∫π - gi·ªØ nguy√™n gh·∫ø ƒëang ch·ªçn:", selectedSeats);
                mySeatIds = selectedSeats;
            }

            // ‚úÖ C·∫≠p nh·∫≠t selectedSeats h·ª£p nh·∫•t
            selectedSeats = [...new Set(mySeatIds)];

            // ‚úÖ Lo·∫°i b·ªè gh·∫ø c·ªßa ch√≠nh m√¨nh kh·ªèi danh s√°ch "occupied" (ƒë·ªÉ m√¨nh v·∫´n ch·ªçn th·∫•y b√¨nh th∆∞·ªùng)
            const myTicketId = Number(localStorage.getItem("tempTicketId"));
            if (myTicketId && Array.isArray(occupiedSeatIds)) {
                const mySeats = selectedSeats;
                occupiedSeatIds = occupiedSeatIds.filter(id => !mySeats.includes(id));
            }

            // ‚úÖ G√°n tr·∫°ng th√°i gh·∫ø
            allSeats.forEach(seat => {
                if (selectedSeats.includes(seat.seatID)) seat.status = "SELECTED"; // m√¨nh ch·ªçn
                else if (occupiedSeatIds.includes(seat.seatID)) seat.status = "HOLDING"; // ng∆∞·ªùi kh√°c ƒëang gi·ªØ
                else seat.status = "AVAILABLE";
            });

            // ‚úÖ T√≠nh l·∫°i t·ªïng gi√° v√©
            const basePrice = window.currentShowtime?.price || 0;
            let total = 0;
            selectedSeats.forEach(id => {
                const seat = allSeats.find(s => s.seatID === id);
                if (seat) total += basePrice * (seat.seatType?.priceMultiplier || 1);
            });
            localStorage.setItem("ticketPriceTotal", String(total));

            renderSeatMap();
            renderSelectedList();

        } catch (err) {
            console.error("‚ùå loadSeats:", err);
        }
    }



    /* ================= RENDER GH·∫æ ================= */
    function createSeatDiv(seat) {
        const div = document.createElement("div");
        div.classList.add("seat");
        div.dataset.id = seat.seatID;
        div.textContent = formatSeatNumber(seat.seatNumber);

        const seatType = seat.seatType || seatTypes.find(t => t.typeID === seat.typeID);
        seat.seatType = seatType;
        const typeName = seatType?.typeName?.toLowerCase() || "normal";
        div.classList.add(typeName === "vip" ? "vip" : typeName === "couple" ? "couple" : "normal");

        if (seat.status === "BOOKED") div.classList.add("booked");
        if (seat.status === "HOLDING") div.classList.add("holding");
        if (seat.status === "SELECTED") div.classList.add("selected");

        div.addEventListener("click", () => {
            if (div.classList.contains("booked") || (div.classList.contains("holding") && !div.classList.contains("selected")))
                return;

            const seatId = seat.seatID;
            const wasSelected = div.classList.contains("selected");
            div.classList.toggle("selected");

            if (wasSelected) {
                selectedSeats = selectedSeats.filter(id => id !== seatId);
            } else {
                selectedSeats.push(seatId);
            }

            renderSelectedList();
        });

        return div;
    }

    function renderSeatMap() {
        const seats = allSeats.sort((a, b) => {
            const rowA = a.seatRow || "", rowB = b.seatRow || "";
            if (rowA !== rowB) return rowA.localeCompare(rowB);
            return (a.seatNumber || 0) - (b.seatNumber || 0);
        });
        seatMap.innerHTML = "";
        const seatsByRow = {};
        seats.forEach(s => {
            const row = s.seatRow || "Unknown";
            if (!seatsByRow[row]) seatsByRow[row] = [];
            seatsByRow[row].push(s);
        });

        Object.keys(seatsByRow).forEach(row => {
            const container = document.createElement("div");
            container.classList.add("row-container");
            const label = document.createElement("div");
            label.classList.add("row-label");
            label.textContent = getRowLetter(row);
            container.appendChild(label);
            const rowSeatsEl = document.createElement("div");
            rowSeatsEl.classList.add("row-seats");
            seatsByRow[row].forEach(seat => rowSeatsEl.appendChild(createSeatDiv(seat)));
            container.appendChild(rowSeatsEl);
            seatMap.appendChild(container);
        });
    }

    function renderSelectedList() {
        selectedList.innerHTML = "";
        if (selectedSeats.length === 0) {
            selectedList.innerHTML = "<li class='text-muted small'>Ch∆∞a c√≥ gh·∫ø n√†o ƒë∆∞·ª£c ch·ªçn.</li>";
            totalDisplay.textContent = "0 VNƒê";
            return;
        }
        const basePrice = window.currentShowtime?.price || 0;
        let total = 0;
        selectedSeats.forEach(id => {
            const seat = allSeats.find(s => s.seatID === id);
            if (seat) {
                const multiplier = seat.seatType?.priceMultiplier || 1;
                const seatPrice = basePrice * multiplier;
                total += seatPrice;
                const li = document.createElement("li");
                li.className = "seat-item";
                li.innerHTML = `<span>${getRowLetter(seat.seatRow)}${formatSeatNumber(seat.seatNumber)}</span> ‚Äì ${seat.seatType?.typeName || "Th∆∞·ªùng"}: ${seatPrice.toLocaleString("vi-VN")}ƒë`;
                selectedList.appendChild(li);
            }
        });
        totalDisplay.textContent = total.toLocaleString("vi-VN") + " VNƒê";
    }

    /* ================= CONFIRM CH·ªåN GH·∫æ ================= */
    confirmBtn.addEventListener("click", async () => {
        if (!selectedSeats.length) {
            Swal.fire("Ch∆∞a ch·ªçn gh·∫ø!", "Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt gh·∫ø ƒë·ªÉ ti·∫øp t·ª•c.", "warning");
            return;
        }

        const token = localStorage.getItem("accessToken");
        const currentTempId = localStorage.getItem("tempTicketId");
        const safeTicketId = currentTempId && currentTempId !== "undefined" ? Number(currentTempId) : null;

        try {
            const body = {
                accountId: Number(accountId),
                showtimeId: Number(showtimeId),
                seatIds: selectedSeats,
                ticketId: safeTicketId
            };

            const res = await fetch(`${API_BASE_URL}/tickets`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(body)
            });

            if (!res.ok) throw new Error(await res.text());
            const ticket = await res.json();

            localStorage.setItem("tempTicketId", ticket.ticketId);
            localStorage.setItem("tempTicket", JSON.stringify(ticket));
            localStorage.setItem("ticketPriceTotal", String(ticket.totalPrice || 0));

            Swal.fire({
                icon: "success",
                title: "üéüÔ∏è Gi·ªØ gh·∫ø th√†nh c√¥ng!",
                text: "H√£y ch·ªçn combo ƒë·ªÉ ho√†n t·∫•t ƒë∆°n ƒë·∫∑t v√©.",
                confirmButtonText: "Ch·ªçn Combo",
                confirmButtonColor: "#e50914",
                allowOutsideClick: false
            }).then(() => {
                const seatParam = encodeURIComponent(selectedSeats.join(","));
                window.location.href = `comboCus.html?branchId=${branchId}&showtimeId=${showtimeId}&accountId=${accountId}&ticketId=${ticket.ticketId}&seatIds=${seatParam}`;
            });
        } catch (err) {
            console.error("‚ùå ƒê·∫∑t v√© l·ªói:", err);
            Swal.fire("Kh√¥ng th·ªÉ gi·ªØ gh·∫ø", err.message || "C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.", "error");
        }
    });

    /* ================= INIT ================= */
    (async () => {
        await loadSeatTypes();
        await loadShowtime();
        setInterval(() => loadSeats(true), 8000); // c·∫≠p nh·∫≠t tr·∫°ng th√°i gh·∫ø m·ªói 8s
    })();
</script>


<script>
    /* ================= HEADER (fix c·ª©ng, ƒë·ªìng b·ªô avatar + t√™n) ================= */
    (async function loadHeader() {
        const headerEl = document.getElementById("header");
        try {
            const res = await fetch("../home/customer-header.html");
            const html = await res.text();
            headerEl.innerHTML = html;

            // ‚úÖ √©p ch·∫°y script trong file header
            const scripts = headerEl.querySelectorAll("script");
            scripts.forEach(s => {
                const ns = document.createElement("script");
                if (s.src) ns.src = s.src;
                else ns.textContent = s.textContent;
                document.body.appendChild(ns);
            });
        } catch (err) {
            console.error("L·ªói load header:", err);
        }
    })();

    // üß© Load footer
    fetch("../home/footer.html")
        .then(r => r.text())
        .then(h => document.getElementById("footer").innerHTML = h);

    // üîπ Tab filter style (n·∫øu c√≥)
    document.querySelectorAll('.filter-tabs button').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.filter-tabs button').forEach(btn => {
                btn.classList.remove('btn-custom-active');
                btn.classList.add('btn-custom-outline');
            });
            this.classList.remove('btn-custom-outline');
            this.classList.add('btn-custom-active');
        });
    });
</script>
</body>
</html>