<!DOCTYPE html>
<html lang="vi">
<head>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta charset="UTF-8">
    <title>Ch·ªçn Combo - CineMaster</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --ink: #06101f;
            --bg: #0b162c;
            --border: #1b2b4a;
            --blue: #0aa3ff;
            --cyan: #22c1ff;
            --red: #e50914;
            --text-light: #e6f1ff;
            --text-muted: #9aa7b3;
        }
        html, body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            color: var(--text-light);
            min-height: 100vh;
            background-color: var(--ink);
            background-image:
                    radial-gradient(1200px 600px at -10% -35%, rgba(10, 163, 255, 0.18), transparent 60%),
                    radial-gradient(900px 400px at 120% -20%, rgba(34, 193, 255, 0.12), transparent 60%),
                    linear-gradient(180deg, var(--ink), var(--bg));
            background-repeat: no-repeat, no-repeat, no-repeat;
            background-size: 1200px 600px, 900px 400px, 100% 100%;
            background-position: -10% -35%, 120% -20%, 0 0;
            background-attachment: fixed, fixed, fixed;
            overflow-x: hidden;
        }
        .promo-banner, .main-container {
            position: relative;
            z-index: 10;
        }
        .promo-banner {
            max-width: 1100px;
            margin: 100px auto 30px;
            background: rgba(8, 20, 40, 0.35);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(34, 193, 255, 0.25);
            border-radius: 12px;
            padding: 18px 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            color: var(--text-light);
        }
        .promo-banner i {
            color: var(--cyan);
            font-size: 1.4rem;
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto 80px;
            display: grid;
            grid-template-columns: 2.3fr 0.9fr;
            gap: 30px;
        }

        /* Combo Grid */
        .combo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 15px;
        }
        .combo-card {
            background: rgba(8, 20, 40, 0.45);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(34, 193, 255, 0.25);
            border-radius: 18px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 0 15px rgba(10, 163, 255, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .combo-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 25px rgba(10, 163, 255, 0.2);
        }
        .combo-img {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            object-fit: cover;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .combo-info {
            flex: 1;
        }
        .combo-info .name {
            font-weight: 700;
            font-size: 1.05rem;
        }
        .combo-info .desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .combo-price {
            color: #ffd700;
            font-weight: 800;
            margin-top: 3px;
        }
        .combo-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .qty-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--cyan);
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            transition: background 0.2s;
        }
        .qty-btn:hover {
            background: rgba(34, 193, 255, 0.2);
        }
        .qty {
            min-width: 24px;
            text-align: center;
            font-weight: 600;
        }

        /* Right Panel */
        .order-panel {
            background: rgba(8, 20, 40, 0.45);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(34, 193, 255, 0.25);
            border-radius: 18px;
            padding: 25px;
            box-shadow: 0 0 20px rgba(10, 163, 255, 0.15);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        .order-divider {
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            margin: 10px 0;
        }
        .order-total {
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 10px;
            padding-top: 10px;
            font-weight: 700;
            color: var(--cyan);
        }
        .btn-pay {
            background: linear-gradient(90deg, var(--blue), var(--cyan));
            border: none;
            color: #fff;
            font-weight: bold;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(34, 193, 255, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-pay:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(34, 193, 255, 0.5);
        }
        .btn-skip {
            border: 1px solid var(--cyan);
            background: transparent;
            color: var(--cyan);
            font-weight: bold;
            padding: 10px;
            border-radius: 10px;
            transition: background 0.2s, color 0.2s;
        }
        .btn-skip:hover {
            background: var(--cyan);
            color: #fff;
        }

        /* Ticket Pattern Overlay */
        .tickets-wall {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 5;
        }
        .tickets-wall .tickets-layer {
            position: absolute;
            inset: -10%;
            background-repeat: repeat;
            background-size: 320px 160px;
            opacity: 0.14;
            filter: drop-shadow(0 0 20px rgba(34, 193, 255, 0.18));
            transform-origin: center center;
        }
        .tickets-wall .l1 {
            transform: rotate(-3deg) scale(1.04);
            background-image: url("data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='160' viewBox='0 0 320 160'%3E%3Crect fill='none' width='320' height='160'/%3E%3Cg opacity='0.95'%3E%3Cg transform='translate(8,8)'%3E%3Cpath d='M0 24 a12 12 0 0 1 12 -12 h200 a10 10 0 0 0 10 -10 a12 12 0 0 1 12 12 v60 a12 12 0 0 1 -12 12 a10 10 0 0 0 -10 10 H12 a12 12 0 0 1 -12 -12z' fill='%23192A43' stroke='%2322c1ff' stroke-width='2'/%3E%3Cline x1='140' y1='12' x2='140' y2='96' stroke='%2322c1ff' stroke-opacity='0.18' stroke-dasharray='6 6' /%3E%3Ccircle cx='60' cy='54' r='22' fill='none' stroke='%2322c1ff' stroke-opacity='0.35' stroke-width='3'/%3E%3Ccircle cx='60' cy='54' r='5' fill='%2322c1ff' opacity='0.3'/%3E%3Cg fill='%2322c1ff' opacity='0.35'%3E%3Ccircle cx='49' cy='44' r='5'/%3E%3Ccircle cx='71' cy='44' r='5'/%3E%3Ccircle cx='49' cy='64' r='5'/%3E%3Ccircle cx='71' cy='64' r='5'/%3E%3C/g%3E%3Cg transform='translate(164,32)' stroke='%230aa3ff' stroke-opacity='0.38'%3E%3Crect x='0' y='0' width='60' height='24' fill='none'/%3E%3Cpath d='M3 0 v24 M8 0 v24 M11 0 v24 M16 0 v24 M22 0 v24 M27 0 v24 M33 0 v24 M38 0 v24 M45 0 v24 M51 0 v24 M56 0 v24' stroke-width='2'/%3E%3C/g%3E%3Cg transform='translate(164,66)' stroke='%230aa3ff' stroke-opacity='0.45'%3E%3Cline x1='0' y1='0' x2='76' y2='0' stroke-width='2'/%3E%3Cline x1='0' y1='10' x2='62' y2='10' stroke-width='2'/%3E%3Cline x1='0' y1='20' x2='70' y2='20' stroke-width='2'/%3E%3C/g%3E%3C/g%3E%3Cg transform='translate(8,88)'%3E%3Cpath d='M0 24 a12 12 0 0 1 12 -12 h200 a10 10 0 0 0 10 -10 a12 12 0 0 1 12 12 v60 a12 12 0 0 1 -12 12 a10 10 0 0 0 -10 10 H12 a12 12 0 0 1 -12 -12z' fill='%231b2f50' stroke='%2322c1ff' stroke-width='2'/%3E%3Cline x1='140' y1='12' x2='140' y2='96' stroke='%2322c1ff' stroke-opacity='0.18' stroke-dasharray='6 6'/%3E%3Ccircle cx='60' cy='54' r='22' fill='none' stroke='%2322c1ff' stroke-opacity='0.32' stroke-width='3'/%3E%3Ccircle cx='60' cy='54' r='5' fill='%2322c1ff' opacity='0.28'/%3E%3Cg fill='%2322c1ff' opacity='0.32'%3E%3Ccircle cx='49' cy='44' r='5'/%3E%3Ccircle cx='71' cy='44' r='5'/%3E%3Ccircle cx='49' cy='64' r='5'/%3E%3Ccircle cx='71' cy='64' r='5'/%3E%3C/g%3E%3Cg transform='translate(164,32)' stroke='%230aa3ff' stroke-opacity='0.38'%3E%3Cpath d='M3 0 v24 M8 0 v24 M11 0 v24 M16 0 v24 M22 0 v24 M27 0 v24 M33 0 v24 M38 0 v24 M45 0 v24 M51 0 v24 M56 0 v24' stroke-width='2'/%3E%3C/g%3E%3Cg transform='translate(164,66)' stroke='%230aa3ff' stroke-opacity='0.45'%3E%3Cline x1='0' y1='0' x2='76' y2='0' stroke-width='2'/%3E%3Cline x1='0' y1='10' x2='62' y2='10' stroke-width='2'/%3E%3Cline x1='0' y1='20' x2='70' y2='20' stroke-width='2'/%3E%3C/g%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .tickets-wall .l2 {
            transform: rotate(3deg) scale(1.06);
            background-position: 160px 80px;
            opacity: 0.10;
            background-image: inherit;
        }

        /* Grain Effect */
        .grain {
            pointer-events: none;
            position: fixed;
            inset: 0;
            opacity: 0.14;
            mix-blend-mode: screen;
            background-image:
                    radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.06) 0 2px, transparent 2px),
                    radial-gradient(circle at 70% 60%, rgba(255, 255, 255, 0.05) 0 2px, transparent 2px);
            background-size: 200px 200px, 260px 260px;
            animation: drift 18s linear infinite alternate;
            z-index: 5;
        }
        @keyframes drift {
            from { transform: translate3d(0, 0, 0); }
            to { transform: translate3d(30px, -25px, 0); }
        }
    </style>
</head>
<body>
<div id="header"></div>

<div class="grain"></div>
<div class="tickets-wall" aria-hidden="true">
    <div class="tickets-layer l1"></div>
    <div class="tickets-layer l2"></div>
</div>



<div class="promo-banner">
    <i class="fas fa-check-circle"></i>
    <span>B·ªè qua h√†ng ch·ªù! ƒê·∫∑t tr∆∞·ªõc combo b·∫Øp n∆∞·ªõc c·ªßa b·∫°n v√† nh·∫≠n t·∫°i qu·∫ßy nhanh. Ti·∫øt ki·ªám th·ªùi gian v√† kh√¥ng b·ªè l·ª° kho·∫£nh kh·∫Øc n√†o c·ªßa b·ªô phim!</span>
</div>

<div class="main-container">
    <div id="comboList" class="combo-grid"></div>

    <div class="order-panel">
        <div>
            <h5><i class="fas fa-cart-shopping me-2"></i> ƒê∆°n h√†ng c·ªßa b·∫°n</h5>
            <div id="movieInfo" class="small text-muted mb-2">ƒêang t·∫£i...</div>
            <div id="selectedCombos"></div>
            <div class="order-divider"></div>
            <div class="order-item"><span>V√© xem phim</span><span id="ticketPriceDisplay">0 VNƒê</span></div>
            <div class="order-item"><span>Combo b·∫Øp n∆∞·ªõc</span><span id="snackTotalDisplay">0 VNƒê</span></div>
            <div class="order-total d-flex justify-content-between"><span>T·ªïng c·ªông</span><span id="grandTotalDisplay">0 VNƒê</span></div>
        </div>
        <div class="mt-3">
            <button id="comboConfirmBtn" class="btn-pay w-100 mb-2">Ti·∫øp t·ª•c thanh to√°n</button>
            <button class="btn-skip w-100" onclick="window.history.back()">B·ªè qua combo</button>
            <button id="backToSeatBtn" class="btn-skip w-100 mb-2">
                <i class="fas fa-chair me-1"></i> Ch·ªçn l·∫°i gh·∫ø
            </button>
            <ul style="list-style:disc;margin-top:10px;padding-left:20px;font-size:0.85rem;color:var(--text-muted);">
                <li>Nh·∫≠n t·∫°i Qu·∫ßy Nhanh #3</li>
                <li>Xu·∫•t tr√¨nh m√£ ƒë·∫∑t v√©</li>
                <li>C√≥ m·∫∑t tr∆∞·ªõc gi·ªù chi·∫øu 30 ph√∫t</li>
            </ul>
        </div>
    </div>

</div>
<div id="footer" style="position: relative; z-index: 20;"></div>

<script type="module">
    import { comboApi } from "../js/api/comboApi.js";
    import { API_BASE_URL } from "../js/api/config.js";

    (async () => {
        const params = new URLSearchParams(window.location.search);
        const showtimeId = params.get("showtimeId");
        const accountId = params.get("accountId") || localStorage.getItem("accountId");
        const branchId = params.get("branchId");
        const seatIds = params.get("seatIds")?.split(",").map(x => Number(x)) || [];
        const ticketIdParam = params.get("ticketId");
        const tempTicketIdLocal = localStorage.getItem("tempTicketId");

        const ticketId = ticketIdParam && ticketIdParam !== "undefined"
            ? Number(ticketIdParam)
            : tempTicketIdLocal
                ? Number(tempTicketIdLocal)
                : null;

        // üß© ƒê·ªìng b·ªô v√© t·∫°m
        let tempTicket = JSON.parse(localStorage.getItem("tempTicket") || "null");
        if (!tempTicket && ticketId && seatIds.length > 0) {
            tempTicket = {
                ticketId,
                ticketSeats: seatIds.map(id => ({ seat: { seatID: id } })),
                status: "HOLDING",
                holdUntil: null,
                totalPrice: Number(localStorage.getItem("ticketPriceTotal") || 0)
            };
            localStorage.setItem("tempTicket", JSON.stringify(tempTicket));
        }

        if (!tempTicket || !ticketId) {
            await Swal.fire("Kh√¥ng c√≥ v√© t·∫°m!", "Vui l√≤ng ch·ªçn gh·∫ø tr∆∞·ªõc.", "info");
            window.location.href = `seat-diagram.html?branchId=${branchId}&showtimeId=${showtimeId}&accountId=${accountId}`;
            return;
        }

        let comboList = [];
        let selectedCombos = JSON.parse(localStorage.getItem("selectedCombos") || "{}");
        let comboTotal = Number(localStorage.getItem("comboTotal") || 0);
        let ticketTotal = Number(localStorage.getItem("ticketPriceTotal") || tempTicket.totalPrice || 0);

        const comboListEl = document.getElementById("comboList");
        const selectedComboEl = document.getElementById("selectedCombos");

        // ================= LOAD COMBOS =================
        async function loadCombos() {
            try {
                comboList = await comboApi.getByBranch(branchId);
                if (!Array.isArray(comboList) || comboList.length === 0) {
                    comboListEl.innerHTML = `<p class="text-center text-gray-500">Kh√¥ng c√≥ combo n√†o cho chi nh√°nh n√†y.</p>`;
                    return;
                }

                comboListEl.innerHTML = comboList.map(c => {
                    const imgSrc = (() => {
                        if (!c.imageURL) return "https://via.placeholder.com/80x80?text=Combo";
                        let path = c.imageURL.trim();
                        if (path.startsWith("http")) return path;
                        if (!path.startsWith("/")) path = "/" + path;
                        return `http://localhost:8080${path}`;
                    })();

                    const currentQty = selectedCombos[String(c.id)] || 0;
                    return `
                        <div class="combo-card">
                            <img src="${imgSrc}" class="combo-img" alt="${c.nameCombo}">
                            <div class="combo-info">
                                <div class="name">${c.nameCombo}</div>
                                <div class="desc">${c.descriptionCombo || ""}</div>
                                <div class="combo-price">${(c.price || 0).toLocaleString("vi-VN")} VNƒê</div>
                            </div>
                            <div class="combo-actions">
                                <button class="qty-btn" data-action="minus" data-id="${c.id}" ${currentQty === 0 ? "disabled" : ""}>‚àí</button>
                                <span class="qty" id="qty-${c.id}">${currentQty}</span>
                                <button class="qty-btn" data-action="plus" data-id="${c.id}">+</button>
                            </div>
                        </div>`;
                }).join("");

                document.querySelectorAll(".qty-btn").forEach(btn => {
                    btn.addEventListener("click", () => {
                        const id = String(btn.dataset.id);
                        if (!selectedCombos[id]) selectedCombos[id] = 0;

                        if (btn.dataset.action === "plus") selectedCombos[id]++;
                        else if (btn.dataset.action === "minus" && selectedCombos[id] > 0) selectedCombos[id]--;

                        document.getElementById(`qty-${id}`).textContent = selectedCombos[id];
                        const minusBtn = btn.closest(".combo-actions").querySelector("[data-action='minus']");
                        minusBtn.disabled = selectedCombos[id] <= 0;

                        updateSummary();
                    });
                });
            } catch (error) {
                console.error("‚ùå L·ªói khi t·∫£i combo:", error);
                comboListEl.innerHTML = `<p class="text-center text-red-500">Kh√¥ng th·ªÉ t·∫£i danh s√°ch combo. Vui l√≤ng th·ª≠ l·∫°i sau.</p>`;
            }
        }

        // ================= UPDATE SUMMARY =================
        function updateSummary() {
            comboTotal = 0;
            selectedComboEl.innerHTML = "";

            for (const [id, qty] of Object.entries(selectedCombos)) {
                const combo = comboList.find(c => c.id == id);
                if (combo && qty > 0) {
                    const subtotal = (combo.price || 0) * qty;
                    comboTotal += subtotal;
                    selectedComboEl.innerHTML += `
                        <div class="order-item">
                            <span>${combo.nameCombo} √ó ${qty}</span>
                            <span>${subtotal.toLocaleString("vi-VN")} VNƒê</span>
                        </div>`;
                }
            }

            const total = ticketTotal + comboTotal;
            document.getElementById("ticketPriceDisplay").textContent = `${ticketTotal.toLocaleString("vi-VN")} VNƒê`;
            document.getElementById("snackTotalDisplay").textContent = `${comboTotal.toLocaleString("vi-VN")} VNƒê`;
            document.getElementById("grandTotalDisplay").textContent = `${total.toLocaleString("vi-VN")} VNƒê`;

            // ‚úÖ L∆∞u t·ªïng t·∫°m ƒë·ªÉ confirmBooking ƒë·ªçc ƒë∆∞·ª£c
            localStorage.setItem("comboTotal", String(comboTotal));
            localStorage.setItem("ticketGrandTotal", String(total));
        }

        // ================= BUTTON X√ÅC NH·∫¨N =================
        document.getElementById("comboConfirmBtn").addEventListener("click", async () => {
            const token = localStorage.getItem("accessToken");

            // G·ª≠i combo v·ªÅ backend
            const comboBody = Object.entries(selectedCombos)
                .filter(([_, qty]) => qty > 0)
                .map(([id, qty]) => ({
                    comboId: Number(id),
                    quantity: qty
                }));

            try {
                await fetch(`${API_BASE_URL}/tickets/${ticketId}/add-combos`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify(comboBody)
                });
                console.log("‚úÖ ƒê√£ l∆∞u combo l√™n backend:", comboBody);
            } catch (err) {
                console.error("‚ùå L·ªói khi g·ª≠i combo l√™n backend:", err);
            }

            // C·∫≠p nh·∫≠t v√© t·∫°m trong localStorage
            const finalTemp = {
                ...(tempTicket || {}),
                ticketId: tempTicket.ticketId || ticketId,
                ticketSeats: tempTicket.ticketSeats || seatIds.map(id => ({ seat: { seatID: id } })),
                seatPrice: ticketTotal,
                comboPrice: comboTotal,
                totalPrice: ticketTotal + comboTotal,
                status: "HOLDING"
            };
            localStorage.setItem("tempTicket", JSON.stringify(finalTemp));

            await Swal.fire({
                title: "ƒê√£ l∆∞u combo!",
                text: "Chuy·ªÉn ƒë·∫øn trang x√°c nh·∫≠n thanh to√°n...",
                icon: "success",
                timer: 1000,
                showConfirmButton: false
            });

            window.location.href =
                `confirmBooking.html?showtimeId=${showtimeId}&accountId=${accountId}&branchId=${branchId}&seatIds=${seatIds.join(",")}&ticketId=${ticketId}`;
        });

        // ================= QUAY L·∫†I CH·ªåN GH·∫æ =================
        document.getElementById("backToSeatBtn").addEventListener("click", async () => {
            const confirm = await Swal.fire({
                title: "Quay l·∫°i ch·ªçn gh·∫ø?",
                text: "C√°c gh·∫ø b·∫°n ƒë√£ ch·ªçn s·∫Ω ƒë∆∞·ª£c kh√¥i ph·ª•c n·∫øu v√© t·∫°m c√≤n hi·ªáu l·ª±c.",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "Quay l·∫°i",
                cancelButtonText: "H·ªßy"
            });
            if (!confirm.isConfirmed) return;

            window.location.href =
                `seat-diagram.html?branchId=${branchId}&showtimeId=${showtimeId}&accountId=${accountId}&ticketId=${ticketId}`;
        });

        // ================= INIT =================
        await loadCombos();
        updateSummary();
    })();
</script>


<script>
    /* ================= HEADER (fix c·ª©ng, ƒë·ªìng b·ªô avatar + t√™n) ================= */
    (async function loadHeader() {
        const headerEl = document.getElementById("header");
        try {
            const res = await fetch("../home/customer-header.html");
            const html = await res.text();
            headerEl.innerHTML = html;

            // ‚úÖ √©p ch·∫°y script trong file header
            const scripts = headerEl.querySelectorAll("script");
            scripts.forEach(s => {
                const ns = document.createElement("script");
                if (s.src) ns.src = s.src;
                else ns.textContent = s.textContent;
                document.body.appendChild(ns);
            });
        } catch (err) {
            console.error("L·ªói load header:", err);
        }
    })();

    // üß© Load footer
    fetch("../home/footer.html")
        .then(r => r.text())
        .then(h => document.getElementById("footer").innerHTML = h);

    // üîπ Tab filter style (n·∫øu c√≥)
    document.querySelectorAll('.filter-tabs button').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.filter-tabs button').forEach(btn => {
                btn.classList.remove('btn-custom-active');
                btn.classList.add('btn-custom-outline');
            });
            this.classList.remove('btn-custom-outline');
            this.classList.add('btn-custom-active');
        });
    });
</script>
</body>
</html>